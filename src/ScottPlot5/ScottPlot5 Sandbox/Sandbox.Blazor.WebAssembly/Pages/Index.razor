@page "/"
@page "/recipe/{selectRecipe?}"

@inject IRecipesService RecipeService
@implements IDisposable

<main>
    @if (RecipeService.HasRecipe)
    {
        <div class="p-3">
            <div class="fs-3">@RecipeService.RecipeName</div>
            <div>@RecipeService.RecipeDescription</div>
        </div>
        <BlazorPlot @ref=BlazorPlot Style="width: min(100%, 800px); height: 600px;" />
        <div class="m-3">
            <div class="bg-light border rounded d-inline-block p-3">
                @if (RecipeService.HasSourceCode)
                {
                    <CodeSnippet Code="@RecipeService.SourceCode" />
                }
                else
                {
                    <p>Loading...</p>
                }
            </div>
        </div>
    }
    <div class="text-muted p-4" style="margin-top: 10rem;">
        @ScottPlot.Version.LongString Running on .NET @Environment.Version
    </div>
</main>

@code {
    [Parameter]
    public string SelectRecipe { get; set; } = string.Empty;


    BlazorPlot BlazorPlot { get; set; } = new();
    string SearchTerm { get; set; } = "";

    protected override void OnInitialized()
    {
        RecipeService.RecipeChanged += this.StateHasChanged; // subscribe
        RecipeService.RecipeChanged += this.UpdatePlot; // subscribe
    }

    public void Dispose()
    {
        RecipeService.RecipeChanged -= this.StateHasChanged; // unsubscribe
        RecipeService.RecipeChanged -= this.UpdatePlot; // subscribe
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(SelectRecipe))
        {
            if (RecipeService.FindRecipe(SelectRecipe))
            {
                ShowRecipe(RecipeService.Recipe!);
            }
        }
    }
    protected void UpdatePlot()
    {
        InvokeAsync(async () =>
        {
            // add little delay to ensure BlazorPlot is visible to ensure refresh works!
            await Task.Delay(1);

            BlazorPlot.Reset();
            RecipeService.Recipe?.Execute(BlazorPlot.Plot);
            BlazorPlot.Refresh();
        });
    }
    protected void ShowRecipe(IRecipe recipe)
    {
        RecipeService.Recipe = recipe;
        UpdatePlot();
    }

    IReadOnlyDictionary<ICategory, IEnumerable<IRecipe>> FilteredRecipes
    {
        get
        {
            var filter = SearchTerm?.Trim();
            if (string.IsNullOrEmpty(filter))
                return RecipeService.RecipesByCategory;

            var d = new Dictionary<ICategory, IEnumerable<IRecipe>>();
            foreach (var x in RecipeService.RecipesByCategory)
            {
                var l = x.Value.Where(v => v.Name.Contains(filter, StringComparison.InvariantCultureIgnoreCase)).ToList();
                if (l.Count > 0)
                    d.Add(x.Key, l);
            }
            return d;
        }
    }
}

